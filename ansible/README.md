# Ansible playbook for the collaboration platform

Этот каталог содержит Ansible-плейбук, который разворачивает полностью приватный стек сервисов для синхронизации файлов, совместной работы с документами и единого входа. Разворачиваются следующие компоненты:

- **Caddy** — единая точка входа и обратный прокси для доменов `*.infra.local` с автоматическим TLS (внутренний CA) и безопасными HTTP-заголовками.
- **Nextcloud** — файловое хранилище и WebDAV-сервер для синхронизации и совместной работы.
- **OnlyOffice Document Server** — онлайн-редактор офисных документов, интегрируемый с Nextcloud через JWT.
- **Authentik** — провайдер SSO (OIDC/SAML) для авторизации пользователей во всех сервисах.
- Вспомогательные сервисы (PostgreSQL, MariaDB, Redis) для хранения данных.

## Структура

- `site.yml` — основной плейбук, который устанавливает Docker, готовит структуру каталогов и поднимает сервисы через Docker Compose.
- `inventory.ini` — базовый инвентарь (по умолчанию локальный хост). При необходимости замените его на адрес целевого сервера.
- `group_vars/all.yml` — общие переменные и секреты (обязательно измените значения по умолчанию перед продакшн-развёртыванием).
- `templates/docker-compose.yml.j2` — шаблон docker-compose файла, описывающий все сервисы.
- `templates/Caddyfile.j2` — конфигурация Caddy с маршрутами и health-чеками.
- `requirements.yml` — список необходимых коллекций Ansible (`community.docker`).

## Предварительные требования

1. На управляющей машине должен быть установлен Ansible ≥ 2.14.
2. Убедитесь, что у вас есть root-доступ (или sudo) к целевому хосту.
3. На целевом хосте должен быть установлен Python 3 (обычно уже есть в Linux-дистрибутивах).

## Быстрый старт

1. Установите зависимости Ansible:

   ```bash
   ansible-galaxy collection install -r requirements.yml
   ```

2. Отредактируйте `group_vars/all.yml`, чтобы указать собственный домен, пароли и секреты.
3. При необходимости обновите `inventory.ini`, указав IP-адрес или доменное имя сервера.
4. Запустите плейбук:

   ```bash
   ansible-playbook site.yml
   ```

После выполнения команды на хосте будет создан каталог `{{ project_root }}` (по умолчанию `/opt/infra`), в котором находится файл `docker-compose.yml` и конфигурации Caddy. Для управления стеком вручную можно использовать команду `docker compose` из этого каталога.

## Подключение сервисов

- Nextcloud: `https://nextcloud.infra.local`
- OnlyOffice: `https://office.infra.local`
- Authentik: `https://auth.infra.local`

> **Важно:** сертификаты Caddy генерируются локальным CA (`tls internal`), поэтому импортируйте корневой сертификат Caddy в доверенные на клиентских устройствах либо замените этот параметр на интеграцию с Let's Encrypt (при наличии публичных доменов).

## Интеграция OnlyOffice и Nextcloud

После первого входа в Nextcloud перейдите в раздел администратора → "Интеграция OnlyOffice" и укажите адрес сервера документов `https://office.infra.local` и секрет JWT из `group_vars/all.yml` (`onlyoffice_jwt_secret`).

## Настройка Authentik как SSO

- Первичный пользователь и пароль создаются при первоначальном запуске Authentik: откройте `https://auth.infra.local/if/flow/initial-setup/`.
- После настройки провайдера OIDC/SAML в Authentik подключите его к Nextcloud и другим сервисам.

## Обновление

Запустите плейбук повторно — он применит обновлённые шаблоны и перезапустит изменившиеся сервисы. Либо выполните:

Повторный запуск плейбука идемпотентен и безопасен: изменятся только файлы шаблонов и контейнеры, которые действительно требуют обновления.


## Устранение неполадок

- Проверьте логи контейнеров: `docker compose logs -f <service>`.
- Убедитесь, что DNS/hosts-записи для `*.infra.local` указывают на IP сервера.
- При изменении паролей и секретов перезапустите связанные сервисы командой `docker compose up -d` в каталоге проекта.
